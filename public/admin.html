<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Monitor — Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #e0e0e0;
      line-height: 1.5;
    }

    header {
      background: linear-gradient(135deg, #111118, #1a1a2e);
      border-bottom: 1px solid #2a2a3a;
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 18px; color: #fff; font-weight: 600; }
    header h1 span { color: #666; font-weight: 400; }
    .header-stats {
      display: flex;
      gap: 24px;
      font-size: 13px;
      color: #888;
    }
    .header-stats .val { color: #fff; font-weight: 600; font-size: 18px; display: block; }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    /* ─── Stats cards ─── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: #111118;
      border: 1px solid #1e1e2e;
      border-radius: 12px;
      padding: 20px;
    }
    .stat-card .label { font-size: 12px; text-transform: uppercase; color: #666; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 28px; font-weight: 700; color: #fff; margin-top: 4px; }
    .stat-card .sub { font-size: 12px; color: #555; margin-top: 4px; }

    /* ─── Sections ─── */
    .section { margin-bottom: 32px; }
    .section h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #1a1a2a;
    }

    /* ─── Bar charts ─── */
    .bar-chart { display: flex; flex-direction: column; gap: 8px; }
    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .bar-label {
      width: 140px;
      font-size: 13px;
      text-align: right;
      color: #aaa;
      flex-shrink: 0;
    }
    .bar-track {
      flex: 1;
      height: 24px;
      background: #111118;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s ease;
      min-width: 2px;
    }
    .bar-count {
      width: 40px;
      font-size: 13px;
      color: #888;
      font-weight: 600;
    }

    /* Type colors */
    .type-security { background: #e74c3c; }
    .type-political { background: #3498db; }
    .type-economic { background: #f39c12; }
    .type-humanitarian { background: #e67e22; }
    .type-infrastructure { background: #9b59b6; }
    .type-legal { background: #1abc9c; }

    /* Severity colors */
    .sev-1 { background: #2ecc71; }
    .sev-2 { background: #27ae60; }
    .sev-3 { background: #f39c12; }
    .sev-4 { background: #e74c3c; }
    .sev-5 { background: #c0392b; }

    /* ─── Alerts ─── */
    .alert-list { display: flex; flex-direction: column; gap: 12px; }
    .alert-card {
      background: #111118;
      border: 1px solid #2a1a1a;
      border-left: 4px solid #e74c3c;
      border-radius: 8px;
      padding: 16px 20px;
    }
    .alert-card.sev-5 { border-left-color: #c0392b; background: #140a0a; }
    .alert-card.sev-4 { border-left-color: #e74c3c; }
    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .alert-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }
    .alert-badges { display: flex; gap: 8px; }
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    .badge-severity { background: #3a1a1a; color: #e74c3c; }
    .badge-type { background: #1a1a2e; color: #3498db; }
    .badge-scope { background: #1a2a1a; color: #2ecc71; }
    .badge-verified { background: #1a2a1a; color: #2ecc71; }
    .badge-reported { background: #2a2a1a; color: #f39c12; }
    .badge-unverified { background: #2a1a1a; color: #e74c3c; }
    .alert-summary { font-size: 13px; color: #aaa; margin-bottom: 8px; }
    .alert-rationale { font-size: 12px; color: #666; font-style: italic; }
    .alert-meta {
      font-size: 11px;
      color: #555;
      margin-top: 8px;
      display: flex;
      gap: 16px;
    }

    /* ─── Event table ─── */
    .event-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .event-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid #1e1e2e;
      color: #666;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .event-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #111118;
      color: #aaa;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .event-table tr:hover td { background: #111118; color: #ddd; }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 500;
      display: inline-block;
    }

    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 800px) { .two-col { grid-template-columns: 1fr; } }

    .empty { color: #444; font-size: 14px; text-align: center; padding: 40px; }
    .loading { color: #666; text-align: center; padding: 60px; font-size: 14px; }

    /* Actor/region pills */
    .actor-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .actor-pill {
      background: #111118;
      border: 1px solid #1e1e2e;
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 13px;
      color: #bbb;
    }
    .actor-pill .count { color: #666; margin-left: 6px; font-weight: 600; }

    /* ─── Data Quality ─── */
    .quality-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .quality-card {
      background: #111118;
      border: 1px solid #1e1e2e;
      border-radius: 8px;
      padding: 14px;
      text-align: center;
    }
    .quality-card .q-val { font-size: 24px; font-weight: 700; color: #fff; }
    .quality-card .q-label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 2px; }
    .quality-card.good .q-val { color: #2ecc71; }
    .quality-card.warn .q-val { color: #f39c12; }
    .quality-card.bad .q-val { color: #e74c3c; }

    .confidence-trend {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 60px;
      margin-top: 12px;
    }
    .trend-bar {
      flex: 1;
      background: #3498db;
      border-radius: 2px 2px 0 0;
      position: relative;
      min-height: 2px;
    }
    .trend-bar .trend-label {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: #888;
      white-space: nowrap;
    }

    .quarantine-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    .quarantine-item {
      background: #111118;
      border: 1px solid #1e1e2e;
      border-left: 3px solid #f39c12;
      border-radius: 6px;
      padding: 10px 14px;
      font-size: 12px;
    }
    .quarantine-item .q-title { color: #ccc; font-weight: 500; margin-bottom: 4px; }
    .quarantine-item .q-reasons { color: #888; }
    .quarantine-item .q-date { color: #555; font-size: 11px; margin-top: 4px; }

    .missing-source-table { width: 100%; font-size: 12px; border-collapse: collapse; }
    .missing-source-table th { text-align: left; color: #666; padding: 6px 8px; border-bottom: 1px solid #1e1e2e; font-size: 11px; text-transform: uppercase; }
    .missing-source-table td { padding: 6px 8px; color: #aaa; border-bottom: 1px solid #111118; }
    .missing-source-table .pct-bar { display: inline-block; height: 8px; border-radius: 4px; vertical-align: middle; margin-left: 6px; }

    /* ─── Digest ─── */
    .digest-topline { margin-bottom: 16px; }
    .digest-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #111118; font-size: 13px; }
    .digest-row .d-type { color: #bbb; }
    .digest-row .d-nums { color: #888; }
    .d-up { color: #e74c3c; font-weight: 600; }
    .d-down { color: #2ecc71; font-weight: 600; }
    .d-flat { color: #666; }
    .digest-events { display: flex; flex-direction: column; gap: 10px; margin-top: 12px; }
    .digest-ev {
      background: #111118;
      border-left: 3px solid #e74c3c;
      border-radius: 6px;
      padding: 10px 14px;
      font-size: 13px;
    }
    .digest-ev.dsev-5 { border-left-color: #c0392b; background: #130a0a; }
    .digest-ev .dev-summary { color: #ddd; font-weight: 500; margin-bottom: 4px; }
    .digest-ev .dev-meta { font-size: 11px; color: #777; }
    .digest-ev .dev-rationale { font-size: 11px; color: #555; font-style: italic; margin-top: 4px; }
  </style>
</head>
<body>
  <header>
    <h1>Horn Monitor <span>/ Admin</span></h1>
    <div class="header-stats" id="headerStats">
      <div>Loading...</div>
    </div>
  </header>

  <div class="container">
    <!-- Stats cards -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card"><div class="label">Loading...</div></div>
    </div>

    <!-- Data Quality -->
    <div class="section" id="qualitySection">
      <h2>Data Quality</h2>
      <div id="qualityContent"><div class="loading">Loading quality metrics...</div></div>
    </div>

    <!-- Alerts: severity 4-5 -->
    <div class="section" id="alertSection">
      <h2>High Severity Alerts (Last 7 Days)</h2>
      <div class="alert-list" id="alertList">
        <div class="loading">Loading alerts...</div>
      </div>
    </div>

    <!-- Weekly Risk Delta -->
    <div class="section" id="digestSection">
      <h2>Weekly Risk Delta <span style="font-size:11px; color:#555; text-transform:none; letter-spacing:0">(auto-generated intelligence brief)</span></h2>
      <div id="digestContent"><div class="loading">Loading digest...</div></div>
      <div style="margin-top:12px; display:flex; gap:12px">
        <a href="/api/admin/digest/html" target="_blank" style="font-size:12px; color:#3498db; text-decoration:none; padding:6px 14px; border:1px solid #1e1e2e; border-radius:6px; background:#111118">View Full HTML</a>
        <a href="/api/admin/digest/text" target="_blank" style="font-size:12px; color:#3498db; text-decoration:none; padding:6px 14px; border:1px solid #1e1e2e; border-radius:6px; background:#111118">View Plain Text</a>
        <a href="/api/admin/digest" target="_blank" style="font-size:12px; color:#3498db; text-decoration:none; padding:6px 14px; border:1px solid #1e1e2e; border-radius:6px; background:#111118">Raw JSON API</a>
      </div>
    </div>

    <!-- Charts row -->
    <div class="two-col">
      <div class="section">
        <h2>Events by Type</h2>
        <div class="bar-chart" id="typeChart"></div>
      </div>
      <div class="section">
        <h2>Severity Distribution</h2>
        <div class="bar-chart" id="severityChart"></div>
      </div>
    </div>

    <div class="two-col">
      <div class="section">
        <h2>Top Actors</h2>
        <div class="actor-list" id="actorList"></div>
      </div>
      <div class="section">
        <h2>Regions</h2>
        <div class="actor-list" id="regionList"></div>
      </div>
    </div>

    <!-- Event log -->
    <div class="section">
      <h2>Recent Events</h2>
      <div style="overflow-x:auto">
        <table class="event-table" id="eventTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Severity</th>
              <th>Scope</th>
              <th>Country</th>
              <th>Regions</th>
              <th>Summary</th>
              <th>Verification</th>
              <th>Sources</th>
            </tr>
          </thead>
          <tbody id="eventBody">
            <tr><td colspan="9" class="loading">Loading events...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const TYPE_COLORS = {
      security: '#e74c3c',
      political: '#3498db',
      economic: '#f39c12',
      humanitarian: '#e67e22',
      infrastructure: '#9b59b6',
      legal: '#1abc9c',
    };
    const SEV_COLORS = { 1: '#2ecc71', 2: '#27ae60', 3: '#f39c12', 4: '#e74c3c', 5: '#c0392b' };
    const SEV_LABELS = { 1: 'Routine', 2: 'Notable', 3: 'Significant', 4: 'Major', 5: 'Critical' };

    async function load() {
      const [eventsRes, alertsRes, actorsRes, regionsRes, qualityRes, digestRes] = await Promise.all([
        fetch('/api/admin/events').then(r => r.json()),
        fetch('/api/admin/alerts').then(r => r.json()),
        fetch('/api/admin/actors').then(r => r.json()),
        fetch('/api/admin/regions').then(r => r.json()),
        fetch('/api/admin/quality').then(r => r.json()),
        fetch('/api/admin/digest').then(r => r.json()),
      ]);

      const { events, stats } = eventsRes;

      if (!stats || stats.totalEvents === 0) {
        document.getElementById('statsGrid').innerHTML =
          '<div class="stat-card"><div class="label">No events yet</div><div class="sub">Load the news feed first to trigger extraction</div></div>';
        renderDataQuality(qualityRes);
        renderDigest(digestRes);
        return;
      }

      renderStats(stats);
      renderDataQuality(qualityRes);
      renderDigest(digestRes);
      renderTypeChart(stats.byType);
      renderSeverityChart(stats.bySeverity);
      renderAlerts(alertsRes.alerts);
      renderActors(actorsRes.actors);
      renderRegions(regionsRes.regions);
      renderEvents(events);
    }

    function renderStats(stats) {
      const missingPct = stats.totalEvents > 0
        ? Math.round((stats.missingRegions / stats.totalEvents) * 100) : 0;

      document.getElementById('headerStats').innerHTML = `
        <div><span class="val">${stats.totalEvents}</span> Total Events</div>
        <div><span class="val">${stats.lastWeek}</span> Last 7 Days</div>
        <div><span class="val">${stats.avgConfidence || '—'}</span> Avg Confidence</div>
      `;

      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
          <div class="label">Total Events</div>
          <div class="value">${stats.totalEvents}</div>
          <div class="sub">${stats.lastWeek} in last 7 days</div>
        </div>
        <div class="stat-card">
          <div class="label">Event Types</div>
          <div class="value">${stats.byType.length}</div>
          <div class="sub">of 6 possible categories</div>
        </div>
        <div class="stat-card">
          <div class="label">Avg Confidence</div>
          <div class="value">${stats.avgConfidence || '—'}</div>
          <div class="sub">0.0 = low, 1.0 = definitive</div>
        </div>
        <div class="stat-card">
          <div class="label">Countries</div>
          <div class="value">${stats.byCountry.length}</div>
          <div class="sub">${stats.byCountry.map(c => c.country).join(', ')}</div>
        </div>
        <div class="stat-card">
          <div class="label">Missing Regions</div>
          <div class="value">${missingPct}%</div>
          <div class="sub">${stats.missingRegions} of ${stats.totalEvents} events</div>
        </div>
      `;
    }

    function renderTypeChart(byType) {
      const max = Math.max(...byType.map(t => t.count), 1);
      document.getElementById('typeChart').innerHTML = byType.map(t => `
        <div class="bar-row">
          <div class="bar-label">${t.event_type}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width:${(t.count/max)*100}%; background:${TYPE_COLORS[t.event_type] || '#666'}"></div>
          </div>
          <div class="bar-count">${t.count}</div>
        </div>
      `).join('');
    }

    function renderSeverityChart(bySev) {
      const max = Math.max(...bySev.map(s => s.count), 1);
      document.getElementById('severityChart').innerHTML = bySev.map(s => `
        <div class="bar-row">
          <div class="bar-label">${s.severity} — ${SEV_LABELS[s.severity] || ''}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width:${(s.count/max)*100}%; background:${SEV_COLORS[s.severity] || '#666'}"></div>
          </div>
          <div class="bar-count">${s.count}</div>
        </div>
      `).join('');
    }

    function renderAlerts(alerts) {
      const el = document.getElementById('alertList');
      if (!alerts || alerts.length === 0) {
        el.innerHTML = '<div class="empty">No high-severity events in the last 7 days</div>';
        return;
      }
      el.innerHTML = alerts.map(a => {
        const regions = safeParseJSON(a.regions);
        const actors = safeParseJSON(a.actors);
        const verClass = `badge-${a.verification_status || 'reported'}`;
        return `
          <div class="alert-card sev-${a.severity}">
            <div class="alert-header">
              <div class="alert-title">${esc(a.primary_title || a.summary)}</div>
              <div class="alert-badges">
                <span class="badge badge-severity">SEV ${a.severity}</span>
                <span class="badge badge-type">${a.event_type}${a.event_subtype ? '/' + a.event_subtype : ''}</span>
                <span class="badge badge-scope">${a.scope || '—'}</span>
                <span class="badge ${verClass}">${a.verification_status || 'reported'}</span>
              </div>
            </div>
            <div class="alert-summary">${esc(a.summary)}</div>
            ${a.rationale ? `<div class="alert-rationale">"${esc(a.rationale)}"</div>` : ''}
            <div class="alert-meta">
              <span>${a.country}${regions.length ? ' / ' + regions.join(', ') : ''}</span>
              <span>Actors: ${actors.length ? actors.join(', ') : '—'}</span>
              <span>Confidence: ${a.confidence}</span>
              <span>${formatDate(a.published_at)}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderActors(actors) {
      const el = document.getElementById('actorList');
      if (!actors || actors.length === 0) {
        el.innerHTML = '<div class="empty">No actors extracted yet</div>';
        return;
      }
      el.innerHTML = actors.slice(0, 15).map(a =>
        `<div class="actor-pill">${esc(a.actor)}<span class="count">${a.count}</span></div>`
      ).join('');
    }

    function renderRegions(regions) {
      const el = document.getElementById('regionList');
      if (!regions || regions.length === 0) {
        el.innerHTML = '<div class="empty">No regions extracted yet</div>';
        return;
      }
      el.innerHTML = regions.map(r =>
        `<div class="actor-pill">${esc(r.region)}<span class="count">${r.count}</span></div>`
      ).join('');
    }

    function renderEvents(events) {
      const tbody = document.getElementById('eventBody');
      if (!events || events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty">No events yet</td></tr>';
        return;
      }
      tbody.innerHTML = events.map(e => {
        const regions = safeParseJSON(e.regions);
        const sources = safeParseJSON(e.sources);
        const sevColor = SEV_COLORS[e.severity] || '#666';
        const typeColor = TYPE_COLORS[e.event_type] || '#666';
        return `
          <tr>
            <td>${formatDate(e.published_at)}</td>
            <td><span class="pill" style="background:${typeColor}22; color:${typeColor}">${e.event_type}${e.event_subtype ? '/' + e.event_subtype : ''}</span></td>
            <td><span class="pill" style="background:${sevColor}22; color:${sevColor}">${e.severity} ${SEV_LABELS[e.severity] || ''}</span></td>
            <td>${e.scope || '—'}</td>
            <td>${esc(e.country)}</td>
            <td>${regions.join(', ') || '—'}</td>
            <td title="${esc(e.summary)}">${esc(truncate(e.summary, 80))}</td>
            <td>${e.verification_status || '—'}</td>
            <td>${sources.length} source${sources.length !== 1 ? 's' : ''}</td>
          </tr>
        `;
      }).join('');
    }

    function renderDigest(d) {
      const el = document.getElementById('digestContent');
      if (!d || !d.topline) { el.innerHTML = '<div class="empty">No digest data yet</div>'; return; }

      function fmtChange(pct) { return pct > 0 ? `+${pct}%` : pct < 0 ? `${pct}%` : 'unchanged'; }
      function chgClass(pct) { return pct > 0 ? 'd-up' : pct < 0 ? 'd-down' : 'd-flat'; }

      let html = `<div style="font-size:16px; color:#fff; font-weight:600; margin-bottom:4px">Week ${d.weekNumber} Risk Delta</div>`;
      html += `<div style="font-size:12px; color:#555; margin-bottom:16px">${d.period.thisWeek}</div>`;

      // Topline
      html += '<div class="digest-topline">';
      html += `<div class="digest-row" style="font-weight:600"><span class="d-type">Total Events</span><span class="d-nums">${d.topline.totalThisWeek} vs ${d.topline.totalLastWeek} <span class="${chgClass(d.topline.totalChange)}">${fmtChange(d.topline.totalChange)}</span></span></div>`;
      for (const t of d.topline.typeShifts) {
        html += `<div class="digest-row"><span class="d-type">${t.type}</span><span class="d-nums">${t.thisWeek} vs ${t.lastWeek} <span class="${chgClass(t.change)}">${fmtChange(t.change)}</span></span></div>`;
      }
      html += '</div>';

      // High-sev events (inline, compact)
      if (d.highSeverity.length > 0) {
        html += '<div style="font-size:12px; color:#666; margin:12px 0 8px">High-Severity Events</div>';
        html += '<div class="digest-events">';
        for (const e of d.highSeverity.slice(0, 5)) {
          const regions = Array.isArray(e.regions) ? e.regions : [];
          html += `<div class="digest-ev ${e.severity >= 5 ? 'dsev-5' : ''}">`;
          html += `<div class="dev-summary">${esc(e.summary)}</div>`;
          html += `<div class="dev-meta"><span class="badge badge-sev">SEV ${e.severity}</span> ${e.eventType} | ${e.country}${regions.length ? ' / ' + regions.join(', ') : ''} | ${e.verificationStatus}</div>`;
          if (e.rationale) html += `<div class="dev-rationale">"${esc(e.rationale)}"</div>`;
          html += '</div>';
        }
        html += '</div>';
      }

      // Hot regions (compact)
      if (d.hotRegions.length > 0) {
        html += '<div style="font-size:12px; color:#666; margin:16px 0 8px">Hot Regions</div>';
        for (const r of d.hotRegions.slice(0, 6)) {
          html += `<div class="digest-row"><span class="d-type">${esc(r.region)}</span><span class="d-nums">${r.count} events, avg sev ${r.avgSeverity} <span class="${chgClass(r.change)}">${fmtChange(r.change)} WoW</span></span></div>`;
        }
      }

      // Actor spikes (compact)
      const spikes = (d.actorSpikes || []).filter(a => a.change !== 0).slice(0, 6);
      if (spikes.length > 0) {
        html += '<div style="font-size:12px; color:#666; margin:16px 0 8px">Actor Spikes</div>';
        for (const a of spikes) {
          html += `<div class="digest-row"><span class="d-type">${esc(a.actor)}</span><span class="d-nums">${a.thisWeek} mentions <span class="${chgClass(a.change)}">${fmtChange(a.change)}</span></span></div>`;
        }
      }

      el.innerHTML = html;
    }

    function renderDataQuality(q) {
      const el = document.getElementById('qualityContent');
      if (!q) { el.innerHTML = '<div class="empty">No quality data</div>'; return; }

      const acceptClass = q.acceptRate >= 90 ? 'good' : q.acceptRate >= 70 ? 'warn' : 'bad';

      let html = `
        <div class="quality-grid">
          <div class="quality-card ${acceptClass}">
            <div class="q-val">${q.acceptRate}%</div>
            <div class="q-label">Accept Rate</div>
          </div>
          <div class="quality-card">
            <div class="q-val">${q.events.total}</div>
            <div class="q-label">Events Stored</div>
          </div>
          <div class="quality-card">
            <div class="q-val">${q.events.last24h}</div>
            <div class="q-label">Events (24h)</div>
          </div>
          <div class="quality-card ${q.quarantine.total > 0 ? 'warn' : 'good'}">
            <div class="q-val">${q.quarantine.total}</div>
            <div class="q-label">Quarantined</div>
          </div>
          <div class="quality-card">
            <div class="q-val">${q.quarantine.last24h}</div>
            <div class="q-label">Quarantined (24h)</div>
          </div>
          <div class="quality-card">
            <div class="q-val">${q.quarantine.last7d}</div>
            <div class="q-label">Quarantined (7d)</div>
          </div>
        </div>
      `;

      // Confidence trend
      if (q.confidenceTrend && q.confidenceTrend.length > 0) {
        const maxConf = 1.0;
        html += '<div style="font-size:12px; color:#666; margin-bottom:4px">Confidence Trend (7 days)</div>';
        html += '<div class="confidence-trend">';
        for (const day of q.confidenceTrend) {
          const pct = (day.avg_confidence / maxConf) * 100;
          html += `<div class="trend-bar" style="height:${pct}%" title="${day.day}: ${day.avg_confidence} (${day.count} events)">
            <span class="trend-label">${day.avg_confidence}</span>
          </div>`;
        }
        html += '</div>';
      }

      // Two columns: missing by source + recent quarantine
      html += '<div class="two-col" style="margin-top:20px">';

      // Missing regions by source
      if (q.missingBySource && q.missingBySource.length > 0) {
        html += '<div>';
        html += '<div style="font-size:12px; color:#666; margin-bottom:8px">Missing Regions by Source</div>';
        html += '<table class="missing-source-table"><thead><tr><th>Source</th><th>Total</th><th>Missing</th><th>%</th></tr></thead><tbody>';
        for (const s of q.missingBySource) {
          const pct = s.total > 0 ? Math.round((s.missing / s.total) * 100) : 0;
          const color = pct > 50 ? '#e74c3c' : pct > 20 ? '#f39c12' : '#2ecc71';
          html += `<tr>
            <td>${esc(s.source_name)}</td>
            <td>${s.total}</td>
            <td>${s.missing}</td>
            <td>${pct}% <span class="pct-bar" style="width:${pct}px; background:${color}"></span></td>
          </tr>`;
        }
        html += '</tbody></table></div>';
      }

      // Recent quarantine
      if (q.recentQuarantine && q.recentQuarantine.length > 0) {
        html += '<div>';
        html += '<div style="font-size:12px; color:#666; margin-bottom:8px">Recent Quarantined</div>';
        html += '<div class="quarantine-list">';
        for (const item of q.recentQuarantine) {
          const reasons = safeParseJSON(item.error_reasons);
          html += `<div class="quarantine-item">
            <div class="q-title">${esc(truncate(item.primary_title, 60))}</div>
            <div class="q-reasons">${reasons.join(', ')}</div>
            <div class="q-date">${formatDate(item.quarantined_at)}</div>
          </div>`;
        }
        html += '</div></div>';
      }

      html += '</div>';
      el.innerHTML = html;
    }

    // Helpers
    function safeParseJSON(s) { try { return JSON.parse(s || '[]'); } catch { return []; } }
    function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function truncate(s, n) { return s && s.length > n ? s.slice(0, n) + '...' : s || ''; }
    function formatDate(d) {
      if (!d) return '—';
      try { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
      catch { return d; }
    }

    load();
  </script>
</body>
</html>
